<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Live Punkte-Spiel</title>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding-top: 60px;
    }
    button {
      padding: 10px 20px;
      margin: 8px;
      font-size: 18px;
      cursor: pointer;
    }
    #points {
      font-size: 24px;
      margin-bottom: 20px;
    }
    #yt-background {
      position: fixed;
      inset: 0;
      z-index: -1;
      pointer-events: none;
    }
    #yt-background iframe {
      width: 100%;
      height: 100%;
    }
    #startScreen, #gameArea {
      display: none;
      flex-direction: column;
      align-items: center;
    }
    #highscoreBox {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255, 215, 0, 0.9);
      color: black;
      padding: 10px;
      border-radius: 10px;
      font-weight: bold;
      text-align: left;
    }
  </style>
</head>
<body>

<!-- Video Hintergrund -->
<div id="yt-background"></div>

<!-- Bestenliste -->
<div id="highscoreBox">Lade Bestenliste‚Ä¶</div>

<!-- Start -->
<div id="startScreen" style="display: flex;">
  <h1>Willkommen!</h1>
  <input id="playerName" placeholder="Dein Name" />
  <button id="startBtn" onclick="startGame()" disabled>Start</button>
</div>

<!-- Spiel -->
<div id="gameArea">
  <div id="points">Punkte: 0</div>

  <div style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
    <button onclick="addPoint()">Punkt sammeln</button>
    <button id="autoclickerButton" onclick="buyAutoclicker()">Autoclicker kaufen (100 Punkte)</button>
    <button onclick="buyBackground()">Subway Surfer aktivieren (1000 Punkte)</button>
    <button onclick="buyFinalVideo()">Finales Video (2.000.000 Punkte)</button>
  </div>

  <div id="congrats" style="display:none; margin-top: 20px; color: yellow; font-size: 20px;">üéâ Gratulation, du hast es geschafft!</div>
  <button id="goBackButton" onclick="goBackToSubway()" style="display:none;">Zur√ºck zu Subway</button>
</div>

<script>
const BIN_ID = "686c0bce8a456b7966bcf833";
const API_KEY = "$2a$10$DIoam2JEjErZBJDn3lcJmO7PpPm7JP1Pr4slNbkFP.gTSmec70A5m";
const jsonHeaders = {
  "Content-Type": "application/json",
  "X-Master-Key": API_KEY
};

let playerName = "";
let points = 0;
let autoclickerSpeed = 1000;
let autoclickerInterval = null;
let autoclickerPrice = 100;
let bgBought = false;
let finalBought = false;
let autoclickerPower = 1;

document.getElementById("playerName").addEventListener("input", () => {
  document.getElementById("startBtn").disabled = !document.getElementById("playerName").value.trim();
});

function startGame() {
  playerName = document.getElementById("playerName").value.trim();
  if (!playerName) return;
  document.getElementById("startScreen").style.display = "none";
  document.getElementById("gameArea").style.display = "block";
  updatePointsDisplay();
  updateAutoclickerButton();
  loadHighscores();
  setInterval(loadHighscores, 2000); // Automatisch neu laden alle 2 Sekunden
}

function updatePointsDisplay() {
  document.getElementById("points").textContent = `Punkte: ${points}`;
}

function updateAutoclickerButton() {
  document.getElementById("autoclickerButton").textContent = `Autoclicker kaufen (${autoclickerPrice} Punkte)`;
}

function addPoint() {
  points++;
  updatePointsDisplay();
  saveScore(playerName, points);
}

function buyAutoclicker() {
  if (points >= autoclickerPrice) {
    points -= autoclickerPrice;
    autoclickerPrice += 50;
    autoclickerSpeed /= 2;
    startOrUpdateAutoclicker();
    updatePointsDisplay();
    updateAutoclickerButton();
    saveScore(playerName, points);
  } else {
    alert("Nicht genug Punkte");
  }
}

function startOrUpdateAutoclicker() {
  clearInterval(autoclickerInterval);
  autoclickerInterval = setInterval(() => {
    points += autoclickerPower;
    updatePointsDisplay();
    saveScore(playerName, points);
  }, autoclickerSpeed);
}

function buyBackground() {
  if (bgBought) return alert("Schon aktiviert");
  if (points >= 1000) {
    points -= 1000;
    autoclickerPower = 2000;
    startOrUpdateAutoclicker();
    updatePointsDisplay();
    showSubwayVideo();
    bgBought = true;
    saveScore(playerName, points);
  } else {
    alert("Nicht genug Punkte");
  }
}

function showSubwayVideo() {
  const id = "vTfD20dbxho";
  document.getElementById("yt-background").innerHTML = `<iframe src="https://www.youtube.com/embed/${id}?autoplay=1&mute=1&loop=1&playlist=${id}" frameborder="0" allow="autoplay" allowfullscreen></iframe>`;
}

function buyFinalVideo() {
  if (finalBought) return alert("Schon aktiviert");
  if (points >= 2000000) {
    points -= 2000000;
    updatePointsDisplay();
    finalBought = true;
    const id = "AgpWX18dby4";
    document.getElementById("yt-background").innerHTML = `<iframe src="https://www.youtube.com/embed/${id}?autoplay=1&mute=1&loop=1&playlist=${id}" frameborder="0" allow="autoplay" allowfullscreen></iframe>`;
    document.getElementById("congrats").style.display = "block";
    document.getElementById("goBackButton").style.display = "inline-block";
    saveScore(playerName, points);
  } else {
    alert("Nicht genug Punkte");
  }
}

function goBackToSubway() {
  showSubwayVideo();
  document.getElementById("congrats").style.display = "none";
  document.getElementById("goBackButton").style.display = "none";
}

async function loadHighscores() {
  try {
    const r = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: jsonHeaders });
    const data = await r.json();
    const scores = data.record.scores || [];
    const box = document.getElementById("highscoreBox");
    box.innerHTML = "<strong>üèÜ Bestenliste</strong><br>";
    scores.forEach((e, i) => {
      box.innerHTML += `${i + 1}. ${e.name}: ${e.score}<br>`;
    });
  } catch (err) {
    console.error("Fehler beim Laden:", err);
    document.getElementById("highscoreBox").textContent = "Fehler beim Laden!";
  }
}

async function saveScore(name, score) {
  try {
    const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
      method: "GET",
      headers: jsonHeaders,
    });
    const data = await response.json();
    const scores = data.record.scores || [];
    const existing = scores.find(s => s.name === name);
    if (existing) {
      existing.score = Math.max(existing.score, score);
    } else {
      scores.push({ name, score });
    }
    scores.sort((a, b) => b.score - a.score);
    const top10 = scores.slice(0, 10);
    await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
      method: "PUT",
      headers: jsonHeaders,
      body: JSON.stringify({ scores: top10 }),
    });
  } catch (e) {
    console.error("Fehler beim Speichern:", e);
  }
}
</script>
</body>
</html>
